/* * MIT Licensed * http://github.com/resumable2/maybe-resumable.js * Aidas Klimas */function maybeResumable(a){var b=new Resumable(a);return b.support?b:new NotResumable(a)}!function(a,b){"use strict";function c(a){if(this.version="2.0.0-alpha",this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),this.support){this.files=[],this.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,method:"multipart",prioritizeFirstAndLastChunk:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,415,500,501]},this.opts={},this.events=[];var b=this;this.onDrop=function(a){a.stopPropagation(),a.preventDefault(),b.addFiles(a.dataTransfer.files,a)},this.preventEvent=function(a){a.preventDefault()},this.opts=c.extend({},this.defaults,a||{})}}function d(a,b){this.resumableObj=a,this.file=b,this.name=b.fileName||b.name,this.size=b.size,this.relativePath=b.webkitRelativePath||this.name,this.uniqueIdentifier=a.generateUniqueIdentifier(b),this.chunks=[],this.paused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevUploadedSize=0,this._prevProgress=0,this.bootstrap()}function e(a,b,c){this.resumableObj=a,this.fileObj=b,this.fileObjSize=b.size,this.offset=c,this.tested=!1,this.retries=0,this.pendingRetry=!1,this.preprocessState=0,this.loaded=0,this.total=0;var d=this.resumableObj.opts.chunkSize;this.startByte=this.offset*d,this.endByte=Math.min(this.fileObjSize,(this.offset+1)*d),this.xhr=null,this.fileObjSize-this.endByte<d&&!this.resumableObj.opts.forceChunkSize&&(this.endByte=this.fileObjSize);var e=this;this.progressHandler=function(a){a.lengthComputable&&(e.loaded=a.loaded,e.total=a.total),e.fileObj.chunkEvent("progress")},this.testHandler=function(){var a=e.status();"success"===a?(e.tested=!0,e.fileObj.chunkEvent(a,e.message()),e.resumableObj.uploadNextChunk()):e.fileObj.paused||(e.tested=!0,e.send())},this.doneHandler=function(){var a=e.status();if("success"===a||"error"===a)e.fileObj.chunkEvent(a,e.message()),e.resumableObj.uploadNextChunk();else{e.fileObj.chunkEvent("retry",e.message()),e.pendingRetry=!0,e.abort(),e.retries++;var b=e.resumableObj.opts.chunkRetryInterval;null!==b?setTimeout(e.send,b):e.send()}}}function f(a){return g(arguments,function(b){b!==a&&g(b,function(b,c){a[c]=b})}),a}function g(a,b,c){var d;if("undefined"!=typeof a.length){for(d=0;d<a.length;d++)if(b.call(c,a[d],d)===!1)return}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d)===!1)return}c.prototype={on:function(a,b){this.events.push(a.toLowerCase(),b)},fire:function(a,b){b=Array.prototype.slice.call(arguments),a=a.toLowerCase();for(var c=!1,d=0;d<=this.events.length;d+=2)this.events[d]===a&&(c=this.events[d+1].apply(this,b.slice(1))===!1||c),"catchall"===this.events[d]&&(c=this.events[d+1].apply(null,b)===!1||c);return!c},generateUniqueIdentifier:function(a){var b=this.opts.generateUniqueIdentifier;if("function"==typeof b)return b(a);var c=a.webkitRelativePath||a.fileName||a.name,d=a.size;return d+"-"+c.replace(/[^0-9a-zA-Z_-]/gim,"")},uploadNextChunk:function(){var a=!1;if(this.opts.prioritizeFirstAndLastChunk&&(g(this.files,function(b){return!b.paused&&b.chunks.length&&"pending"===b.chunks[0].status()&&0===b.chunks[0].preprocessState?(b.chunks[0].send(),a=!0,!1):!b.paused&&b.chunks.length>1&&"pending"===b.chunks[b.chunks.length-1].status()&&0===b.chunks[0].preprocessState?(b.chunks[b.chunks.length-1].send(),a=!0,!1):void 0}),a))return a;if(g(this.files,function(b){return b.paused||g(b.chunks,function(b){return"pending"===b.status()&&0===b.preprocessState?(b.send(),a=!0,!1):void 0}),a?!1:void 0}),a)return!0;var b=!1;return g(this.files,function(a){return a.isComplete()?void 0:(b=!0,!1)}),b||this.fire("complete"),!1},assignBrowse:function(a,c,d){"undefined"==typeof a.length&&(a=[a]),g(a,function(a){var e;"INPUT"===a.tagName&&"file"===a.type?e=a:(e=b.createElement("input"),e.setAttribute("type","file"),f(a.style,{display:"inline-block",position:"relative",overflow:"hidden",verticalAlign:"top"}),f(e.style,{position:"absolute",top:0,right:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,opacity:0,cursor:"pointer"}),a.appendChild(e)),this.opts.singleFile||d||e.setAttribute("multiple","multiple"),c&&e.setAttribute("webkitdirectory","webkitdirectory");var g=this;e.addEventListener("change",function(a){g.addFiles(a.target.files,a),a.target.value=""},!1)},this)},assignDrop:function(a){"undefined"==typeof a.length&&(a=[a]),g(a,function(a){a.addEventListener("dragover",this.preventEvent,!1),a.addEventListener("dragenter",this.preventEvent,!1),a.addEventListener("drop",this.onDrop,!1)},this)},unAssignDrop:function(a){"undefined"==typeof a.length&&(a=[a]),g(a,function(a){a.removeEventListener("dragover",this.preventEvent),a.removeEventListener("dragenter",this.preventEvent),a.removeEventListener("drop",this.onDrop)},this)},isUploading:function(){var a=!1;return g(this.files,function(b){return b.isUploading()?(a=!0,!1):void 0}),a},upload:function(){if(!this.isUploading()){this.fire("uploadStart");for(var a=1;a<=this.opts.simultaneousUploads;a++)this.uploadNextChunk()}},resume:function(){g(this.files,function(a){a.resume()})},pause:function(){g(this.files,function(a){a.pause()})},cancel:function(){for(var a=this.files.length-1;a>=0;a--)this.files[a].cancel()},progress:function(){var a=0,b=0;return g(this.files,function(c){a+=c.progress()*c.size,b+=c.size}),b>0?a/b:0},addFile:function(a,b){this.addFiles([a],b)},addFiles:function(a,b){var c=[];g(a,function(a){if((a.size||"."!==a.name&&"."!==a.fileName)&&!this.getFromUniqueIdentifier(this.generateUniqueIdentifier(a))){var e=new d(this,a);this.fire("fileAdded",e,b)&&c.push(e)}},this),this.fire("filesAdded",c,b)&&g(c,function(a){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(a)},this),this.fire("filesSubmitted",c,b)},removeFile:function(a){for(var b=this.files.length-1;b>=0;b--)this.files[b]===a&&(this.files.splice(b,1),a.abort())},getFromUniqueIdentifier:function(a){var b=!1;return g(this.files,function(c){c.uniqueIdentifier===a&&(b=c)}),b},getSize:function(){var a=0;return g(this.files,function(b){a+=b.size}),a}},d.prototype={measureSpeed:function(){var a=this.resumableObj.opts.speedSmoothingFactor,b=Date.now()-this._lastProgressCallback,c=this.sizeUploaded();this.currentSpeed=Math.max(1e3*((c-this._prevUploadedSize)/b),0),this.averageSpeed=a*this.currentSpeed+(1-a)*this.averageSpeed,this._prevUploadedSize=c},chunkEvent:function(a,b){switch(a){case"progress":if(Date.now()-this._lastProgressCallback<this.resumableObj.opts.progressCallbacksInterval)break;this.measureSpeed(),this.resumableObj.fire("fileProgress",this),this.resumableObj.fire("progress"),this._lastProgressCallback=Date.now();break;case"error":this.error=!0,this.abort(),this.chunks=[],this.resumableObj.fire("fileError",this,b),this.resumableObj.fire("error",b,this);break;case"success":if(this.error)return;this.resumableObj.fire("fileProgress",this),this.resumableObj.fire("progress"),this.isComplete()&&this.resumableObj.fire("fileSuccess",this,b);break;case"retry":this.resumableObj.fire("fileRetry",this)}},pause:function(){this.paused=!0,this.abort()},resume:function(){this.paused=!1,this.resumableObj.upload()},abort:function(){this.currentSpeed=0,this.averageSpeed=0,g(this.chunks,function(a){"uploading"===a.status()&&(a.abort(),this.resumableObj.uploadNextChunk())},this)},cancel:function(){this.resumableObj.removeFile(this)},retry:function(){this.bootstrap(),this.resumableObj.upload()},bootstrap:function(){this.abort(),this.error=!1,this.chunks=[],this._prevProgress=0;for(var a=this.resumableObj.opts.forceChunkSize?Math.ceil:Math.floor,b=Math.max(a(this.file.size/this.resumableObj.opts.chunkSize),1),c=0;b>c;c++)this.chunks.push(new e(this.resumableObj,this,c))},progress:function(){if(this.error)return 1;var a=0;g(this.chunks,function(b){a+=b.progress()*(b.endByte-b.startByte)});var b=a/this.size;return this._prevProgress=Math.max(this._prevProgress,b>.999?1:b),this._prevProgress},isUploading:function(){var a=!1;return g(this.chunks,function(b){return"uploading"===b.status()?(a=!0,!1):void 0}),a},isComplete:function(){var a=!1;return g(this.chunks,function(b){var c=b.status();return"pending"===c||"uploading"===c||1===b.preprocessState?(a=!0,!1):void 0}),!a},sizeUploaded:function(){var a=0;return g(this.chunks,function(b){a+="success"===b.status()?b.endByte-b.startByte:b.loaded}),a},timeRemaining:function(){return this.averageSpeed?Math.floor(Math.max(this.size-this.sizeUploaded(),0)/this.averageSpeed):0},getType:function(){return this.file.type&&this.file.type.split("/")[1]},getExtension:function(){return this.name.substr((~-this.name.lastIndexOf(".")>>>0)+2).toLowerCase()}},e.prototype={getParams:function(){return{resumableChunkNumber:this.offset+1,resumableChunkSize:this.resumableObj.opts.chunkSize,resumableCurrentChunkSize:this.endByte-this.startByte,resumableTotalSize:this.fileObjSize,resumableIdentifier:this.fileObj.uniqueIdentifier,resumableFilename:this.fileObj.name,resumableRelativePath:this.fileObj.relativePath,resumableTotalChunks:this.fileObj.chunks.length}},getTarget:function(a){var b=this.resumableObj.opts.target;return b+=b.indexOf("?")<0?"?":"&",b+a.join("&")},test:function(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.testHandler,!1),this.xhr.addEventListener("error",this.testHandler,!1);var a=this.prepareXhrRequest("GET");this.xhr.send(a)},preprocessFinished:function(){this.preprocessState=2,this.send()},send:function(){var a=this.resumableObj.opts.preprocess;if("function"==typeof a)switch(this.preprocessState){case 0:return a(this),this.preprocessState=1,void 0;case 1:return;case 2:}if(this.resumableObj.opts.testChunks&&!this.tested)return this.test(),void 0;this.loaded=0,this.total=0,this.pendingRetry=!1;var b=this.fileObj.file.slice?"slice":this.fileObj.file.mozSlice?"mozSlice":this.fileObj.file.webkitSlice?"webkitSlice":"slice",c=this.fileObj.file[b](this.startByte,this.endByte);this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler,!1),this.xhr.addEventListener("load",this.doneHandler,!1),this.xhr.addEventListener("error",this.doneHandler,!1);var d=this.prepareXhrRequest("POST",this.resumableObj.opts.method,c);this.xhr.send(d)},abort:function(){var a=this.xhr;this.xhr=null,a&&a.abort()},status:function(){return this.pendingRetry?"uploading":this.xhr?this.xhr.readyState<4?"uploading":200==this.xhr.status?"success":this.resumableObj.opts.permanentErrors.indexOf(this.xhr.status)>-1||this.retries>=this.resumableObj.opts.maxChunkRetries?"error":(this.abort(),"pending"):"pending"},message:function(){return this.xhr?this.xhr.responseText:""},progress:function(){if(this.pendingRetry)return 0;var a=this.status();return"success"===a||"error"===a?1:"pending"===a?0:this.total>0?this.loaded/this.total:0},prepareXhrRequest:function(a,b,c){var d=this.resumableObj.opts.query;"function"==typeof d&&(d=d(this.fileObj,this)),d=f(this.getParams(),d);var e=this.resumableObj.opts.target,h=null;if("GET"===a||"octet"===b){var i=[];g(d,function(a,b){i.push([encodeURIComponent(b),encodeURIComponent(a)].join("="))}),e=this.getTarget(i),h=c||null}else h=new FormData,g(d,function(a,b){h.append(b,a)}),h.append(this.resumableObj.opts.fileParameterName,c);return this.xhr.open(a,e),this.xhr.withCredentials=this.resumableObj.opts.withCredentials,g(this.resumableObj.opts.headers,function(a,b){this.xhr.setRequestHeader(b,a)},this),h}},c.extend=f,c.each=g,c.ResumableFile=d,c.ResumableChunk=e,a.Resumable=c}(window,document),"undefined"!=typeof module&&(module.exports=window.Resumable),"undefined"!=typeof module&&(module.exports=maybeResumable),function(Resumable,window,document,undefined){"use strict";function stopEvent(a){a.stopPropagation(),a.preventDefault()}function addEvent(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c}function removeEvent(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):a["on"+b]=null}function removeElement(a){a.parentNode.removeChild(a)}function parseJson(json){return window.JSON?JSON.parse(json):eval("("+json+")")}function isFunction(a){var b={};return a&&"[object Function]"===b.toString.call(a)}function NotResumable(a){this.support=!1,this.files=[],this.events=[],this.defaults={simultaneousUploads:3,fileParameterName:"file",query:{},target:"/",generateUniqueIdentifier:null};var b=this;this.inputChangeEvent=function(a){var c=a.srcElement;removeEvent(c,"change",b.inputChangeEvent),b.addFile(c,a);var d=c.cloneNode();c.parentNode.replaceChild(d,c),d.value="",addEvent(d,"change",b.inputChangeEvent)},this.opts=Resumable.extend({},this.defaults,a||{})}function NotResumableFile(a,b){this.resumableObj=a,this.element=b,this.name=b.value&&b.value.replace(/.*(\/|\\)/,""),this.relativePath=this.name,this.uniqueIdentifier=a.generateUniqueIdentifier(b),this.iFrame=null,this.finished=!1,this.error=!1;var c=this;this.iFrameLoaded=function(){if(c.iFrame&&c.iFrame.parentNode){try{if(c.iFrame.contentDocument&&c.iFrame.contentDocument.body&&"false"==c.iFrame.contentDocument.body.innerHTML)return}catch(a){c.error=!0,c.resumableObj.fire("fileError",c,a)}var b=c.iFrame.contentDocument||c.iFrame.contentWindow.document,d=b.body.innerText;c.abort(),c.finished=!0,c.resumableObj.fire("fileSuccess",c,d),c.resumableObj.upload()}},this.bootstrap()}var extend=Resumable.extend,each=Resumable.each;NotResumable.prototype={on:Resumable.prototype.on,fire:Resumable.prototype.fire,cancel:Resumable.prototype.cancel,assignBrowse:function(a){"undefined"==typeof a.length&&(a=[a]),each(a,function(a){var b;"INPUT"===a.tagName&&"file"===a.type?b=a:(b=document.createElement("input"),b.setAttribute("type","file"),extend(a.style,{display:"inline-block",position:"relative",overflow:"hidden",verticalAlign:"top"}),extend(b.style,{position:"absolute",top:0,right:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,opacity:0,cursor:"pointer"}),a.appendChild(b)),addEvent(b,"change",this.inputChangeEvent)},this)},assignDrop:function(){},unAssignDrop:function(){},isUploading:function(){var a=!1;return each(this.files,function(b){return b.isUploading()?(a=!0,!1):void 0}),a},upload:function(){var a=0;each(this.files,function(b){if(1!=b.progress()){if(b.isUploading())return a++,void 0;if(a++>=this.opts.simultaneousUploads)return!1;1==a&&this.fire("uploadStart"),b.send()}},this),a||this.fire("complete")},pause:function(){each(this.files,function(a){a.abort()})},resume:function(){this.upload()},progress:function(){var a=0,b=0;return each(this.files,function(c){a+=c.progress(),b++}),totalSize>0?a/b:0},addFiles:function(a,b){var c=[];each(a,function(a){if(1===a.nodeType&&a.value){var d=new NotResumableFile(this,a);this.fire("fileAdded",d,b)&&c.push(d)}},this),this.fire("filesAdded",c,b)&&each(c,function(a){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(a)},this),this.fire("filesSubmitted",c,b)},addFile:function(a,b){this.addFiles([a],b)},generateUniqueIdentifier:function(a){var b=this.opts.generateUniqueIdentifier;return"function"==typeof b?b(a):"xxxxxxxx-xxxx-yxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})},getFromUniqueIdentifier:function(a){var b=!1;return each(this.files,function(c){c.uniqueIdentifier==a&&(b=c)}),b},removeFile:function(a){for(var b=this.files.length-1;b>=0;b--)this.files[b]===a&&this.files.splice(b,1)},getSize:function(){}},NotResumableFile.prototype={getExtension:Resumable.ResumableFile.prototype.getExtension,getType:function(){},send:function(){if(!this.finished){var a=this.resumableObj.opts,b=this.createForm(),c=a.query;isFunction(c)&&(c=c(this)),c[a.fileParameterName]=this.element,c.resumableFilename=this.fileName,c.resumableRelativePath=this.relativePath,c.resumableIdentifier=this.uniqueIdentifier,this.addFormParams(b,c),addEvent(this.iFrame,"load",this.iFrameLoaded),b.submit(),removeElement(b)}},abort:function(){this.iFrame&&(this.iFrame.setAttribute("src","java"+String.fromCharCode(115)+"cript:false;"),removeElement(this.iFrame),this.iFrame=null)},cancel:function(){this.abort(),this.resumableObj.removeFile(this)},retry:function(){this.bootstrap(),this.resumableObj.upload()},bootstrap:function(){this.abort(),this.error=!1},timeRemaining:function(){},sizeUploaded:function(){},resume:function(){this.resumableObj.upload()},pause:function(){this.abort()},isUploading:function(){return null!==this.iFrame},isComplete:function(){return 1===this.progress()},progress:function(){return this.error?1:this.finished?1:0},createIframe:function(){var a=/MSIE (6|7|8)/.test(navigator.userAgent)?document.createElement('<iframe name="'+this.uniqueIdentifier+"_iframe"+'">'):document.createElement("iframe");return a.setAttribute("id",this.uniqueIdentifier+"_iframe_id"),a.setAttribute("name",this.uniqueIdentifier+"_iframe"),a.style.display="none",document.body.appendChild(a),a},createForm:function(){var a=this.resumableObj.opts.target,b=document.createElement("form");return b.encoding="multipart/form-data",b.method="POST",b.setAttribute("action",a),this.iFrame||(this.iFrame=this.createIframe()),b.setAttribute("target",this.iFrame.name),b.style.display="none",document.body.appendChild(b),b},addFormParams:function(a,b){var c;each(b,function(b,d){b&&1===b.nodeType?c=b:(c=document.createElement("input"),c.setAttribute("value",b)),c.setAttribute("name",d),a.appendChild(c)})}},NotResumable.NotResumableFile=NotResumableFile,window.NotResumable=NotResumable}(window.Resumable,window,document),"undefined"!=typeof module&&(module.exports=window.NotResumable);